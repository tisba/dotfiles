#!/usr/bin/env bash

set -e

# NOTE: This script downloads Firefox 68.12.0 ESR and injects a policy.json
#       to disable auto-updates.
#       ~/Downloads will contain the downloaded DMG and the Firefox.app

# See https://github.com/mozilla/policy-templates/blob/master/README.md

cd ~/Downloads

echo
echo "===> Downloading Firefox 68.12.0 ESR"
curl -O https://ftp.mozilla.org/pub/firefox/releases/68.12.0esr/mac/en-US/Firefox%2068.12.0esr.dmg

echo
echo "===> Mounting DMG"
hdiutil attach ~/Downloads/Firefox%2068.12.0esr.dmg

echo
echo "===> Copying Firefox.app"
cp -a /Volumes/Firefox/Firefox.app ~/Downloads/Firefox-68.12.0.esr.app

echo
echo "===> Unmounting DMG"
hdiutil detach /Volumes/Firefox

echo
echo "===> Inject policies.json"
mkdir ~/Downloads/Firefox-68.12.0.esr.app/Contents/Resources/distribution/
cat << EOF > ~/Downloads/Firefox-68.12.0.esr.app/Contents/Resources/distribution/policies.json
{
  "policies": {
    "DisableAppUpdate": true,
    "DontCheckDefaultBrowser": true
  }
}
EOF

echo "===> Remove com.apple.quarantine"
xattr -r -d com.apple.quarantine ~/Downloads/Firefox-68.12.0.esr.app

echo
echo "===> DONE!"
echo
echo "You can now open ~/Downloads/Firefox-68.12.0.esr.app"
echo
echo "It won't nag you with setting it as a default browser and"
echo "it also won't auto-update!"
